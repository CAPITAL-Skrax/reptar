<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/file.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/reptar/reptar" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/file-system.js~FileSystem.html">FileSystem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/file.js~File.html">File</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/index.js~Reptar.html">Reptar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/metadata.js~Metadata.html">Metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createChecksum">createChecksum</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addDataFiles">addDataFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readDataFiles">readDataFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-cache">cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Constants">Constants</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Url">Url</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">cli</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-build">build</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clean">clean</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-init">init</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-new">new</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-serve">serve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-watch">watch</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">collection</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/collection/base.js~CollectionBase.html">CollectionBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/collection/page.js~CollectionPage.html">CollectionPage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addCollections">addCollections</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createCollection">createCollection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">collection/type</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/collection/type/file-system.js~FileSystemCollection.html">FileSystemCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/collection/type/metadata.js~MetadataCollection.html">MetadataCollection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">config</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/config/index.js~Config.html">Config</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">filter</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-futureDatesFilter">futureDatesFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-metadataFilter">metadataFilter</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">parse</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fileHasFrontmatter">fileHasFrontmatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parse">parse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parse">parse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">renderer</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/renderer/renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createMarkdownEngine">createMarkdownEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-renderMarkdown">renderMarkdown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addTemplateFilter">addTemplateFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-configureTemplateEngine">configureTemplateEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-renderTemplate">renderTemplate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-renderTemplateString">renderTemplateString</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/file.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import path from &apos;path&apos;;
import Promise from &apos;bluebird&apos;;
import fs from &apos;fs-extra&apos;;
import _ from &apos;lodash&apos;;
import createChecksum from &apos;./checksum&apos;;
import log from &apos;./log&apos;;
import Url from &apos;./url&apos;;
import Parse from &apos;./parse&apos;;
import cache from &apos;./cache&apos;;
import filter from &apos;./filter&apos;;

export default class File {
  constructor(
    filePath = &apos;&apos;,
    {
      config,
      renderer,
    } = {}
  ) {
    /**
     * Unique ID for this file. Right now an alias for the file&apos;s path.
     * @type {string}
     */
    this.id = filePath;

    /**
     * Absolute path to file location.
     * @type {string}
     */
    this.path = filePath;

    /**
     * Absolute destination path of where file should be written.
     * @type {string} destination Absolute path to file.
     */
    this.destination = &apos;&apos;;

    /**
     * Frontmatter for this file. Can be undefined if a file has no frontmatter.
     * @type {object}
     */
    this.frontmatter = Object.create(null);

    /**
     * Template accessible data.
     * @type {Object.&lt;string, Object&gt;}
     */
    this.data = Object.create(null);

    /**
     * Should we skip processing this file, ignoring templates and markdown
     * conversion. This is generally only true for images and similar files.
     * @type {boolean}
     */
    this.skipProcessing = false;

    /**
     * If this File is filtered out of rendering. Filter settings are defined
     * in the {@link Config.ConfigFilename} file.
     * @type {boolean}
     */
    this.filtered = false;

    /**
     * @type {Config}
     * @private
     */
    this._config = config;

    /**
     * @type {Renderer}
     * @private
     */
    this._renderer = renderer;
  }

  /**
   * Update&apos;s File&apos;s data from the file system.
   */
  async update() {
    // Check if a file has frontmatter.
    const hasFrontmatter = await Parse.fileHasFrontmatter(this.path);

    // If File doesn&apos;t have frontmatter then return early.
    if (!hasFrontmatter) {
      const assetConfig = this._config.get(&apos;assets&apos;).find(
        ({ test }) =&gt; test(this.path)
      );

      if (assetConfig) {
        this.assetProcessor = assetConfig.use;
      }

      this.skipProcessing = true;
      this._calculateDestination();
      return;
    }

    /**
     * Raw contents of file, directly from file system.
     * @type {string} One long string.
     */
    const rawContent = await Promise.fromCallback(cb =&gt;
      fs.readFile(this.path, &apos;utf8&apos;, cb)
    );

    /**
     * Checksum hash of rawContent, for use in seeing if file is different.
     * @example:
     *  &apos;50de70409f11f87b430f248daaa94d67&apos;
     * @type {string}
     */
    this.checksum = createChecksum(rawContent);

    // Try to parse File&apos;s frontmatter.
    let parsedContent;
    try {
      parsedContent = Parse.fromFrontMatter(rawContent);
    } catch (e) {
      // Couldn&apos;t parse File&apos;s frontmatter.
    }

    // Ensure we have an object to dereference.
    if (!_.isObject(parsedContent)) {
      parsedContent = {};
    }

    const {
      data: frontmatter,
      // The file&apos;s text content.
      content,
    } = parsedContent;

    // Create new data object.
    this.data = Object.create(null);

    this.frontmatter = frontmatter;

    this.defaults = this._gatherDefaults();

    // Merge in new data that&apos;s accessible from template.
    _.merge(this.data, this.defaults, this.frontmatter, {
      // The content of the Page.
      content,
    });

    this.filtered = filter.isFileFiltered(
      this._config.get(&apos;file.filters&apos;),
      this
    );

    try {
      this._calculateDestination();
    } catch (e) {
      throw new Error(
        &apos;Unable to calculate destination for file at &apos; +
        `${this.path}. Message: ${e.message}`
      );
    }
  }

  /**
   * Gather default values that should be applied to this file.
   * @return {Object} Default values applied to this file.
   */
  _gatherDefaults() {
    // Defaults are sorted from least to most specific, so we iterate over them
    // in the reverse order to allow most specific first chance to apply their
    // values.
    return _.reduceRight(
      this._config.get(&apos;file.defaults&apos;),
      (acc, defaultObj) =&gt; {
        const { scope, values } = defaultObj;

        // If default path property is defined does it exist within this file&apos;s
        // path.
        const pathMatches = scope.path != null ?
          this.path.includes(scope.path) :
          true;

        // If metadata is set the does it match the file&apos;s metadata.
        const metadataMatches = _.isObject(scope.metadata) ?
          _.isMatch(this.frontmatter, scope.metadata) :
          true;

        // If we have a match then apply the values.
        if (pathMatches &amp;&amp; metadataMatches) {
          return _.defaults(acc, values);
        }

        return acc;
      },
      {}
    );
  }

  /**
   * Calculate both relative and absolute destination path for where to write
   * the file.
   * @private
   */
  _calculateDestination() {
    let destinationUrl;

    /**
     * If the file itself wants to customize what its URL is then it will use
     * the `config.file.urlKey` value of the File&apos;s frontmatter as the basis
     * for which the URL of this file should be.
     * So if you have a File with a frontmatter that has `url: /pandas/` then
     * the File&apos;s URL will be `/pandas/`.
     * @type {string?} url Relative path to file.
     */
    const url = this.frontmatter[this._config.get(&apos;file.urlKey&apos;)];

    if (url) {
      // If the individual File defined its own unique URL that gets first
      // dibs at setting the official URL for this file.
      destinationUrl = url;
    } else if (this.data.permalink) {
      // If the file has no URL but has a permalink set on it then use it to
      // find the URL of the File.
      destinationUrl = Url.interpolatePermalink(
        this.data.permalink,
        this.data
      );
    } else {
      // Path to file relative to root of project.
      const pathRelative = this.path.replace(
        this._config.get(&apos;path.source&apos;),
        &apos;&apos;
      );

      // If the file has no URL set and no permalink then use its relative file
      // path as its url.
      destinationUrl = Url.replaceMarkdownExtension(
        pathRelative,
        this._config.get(&apos;markdown.extensions&apos;)
      );
    }

    if (this.assetProcessor) {
      destinationUrl = this.assetProcessor.calculateDestination(destinationUrl);
    }

    this.destination = Url.makeUrlFileSystemSafe(destinationUrl);
    this.data.url = Url.makePretty(this.destination);
  }

  /**
   * Render the markdown into HTML.
   * If there is an assetProcessor then we delegate render responsibility to
   * that assetProcessor.
   * @param {Object} globalData Global site metadata.
   * @return {string} Rendered content.
   */
  render(globalData) {
    if (this.assetProcessor) {
      return this.assetProcessor.render(this);
    }

    const template = this.data.template;

    let result = this.data.content;

    const templateData = {
      ...globalData,
      file: this.data,
    };

    try {
      // Set result of content to result content.
      result = this._renderer.renderTemplateString(
        this.data.content,
        templateData
      );

      // Set result to file&apos;s contents.
      this.data.content = result;
    } catch (e) {
      log.error(e.message);
      throw new Error(&apos;File: Could not render file\&apos;s contents.\n&apos; +
        `File: ${JSON.stringify(this)}`);
    }

    // Convert to HTML.
    // However if the File&apos;s frontmatter sets markdown value to false then
    // skip the markdown conversion.
    if (this.data.markdown !== false) {
      result = this._renderer.renderMarkdown(this.data.content);
      this.data.content = result;
    }

    if (
      !_.isNil(template) &amp;&amp;
      !(_.isString(template) &amp;&amp; template.length === 0)
    ) {
      result = this._renderer.renderTemplate(template, templateData);
    }

    return result;
  }

  /**
   * Writes a given File object to the file system.
   * @param {Object} globalData Site wide data.
   */
  async write(globalData) {
    const destinationPath = path.join(
      this._config.get(&apos;path.destination&apos;),
      this.destination
    );

    if (this.assetProcessor) {
      const content = await this.render(this);
      await Promise.fromCallback((cb) =&gt; {
        fs.outputFile(destinationPath, content, &apos;utf8&apos;, cb);
      });
      return;
    }

    // If this File is a static asset then we don&apos;t process it at all, and just
    // copy it to its destination path.
    // This typically applies to images and other similar files.
    if (this.skipProcessing) {
      await Promise.fromCallback(cb =&gt;
        fs.copy(this.path, destinationPath, cb)
      );
      return;
    }

    // Don&apos;t write File if it is filtered.
    if (this.filtered) {
      return;
    }

    const content = await this.render(globalData);

    if (this._config.get(&apos;incremental&apos;) &amp;&amp;
        cache.get(this.path) === this.checksum) {
      return;
    }

    await Promise.fromCallback((cb) =&gt; {
      fs.outputFile(destinationPath, content, &apos;utf8&apos;, cb);
    });

    // Save checksum to cache for incremental builds.
    cache.put(this.path, this.checksum);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
